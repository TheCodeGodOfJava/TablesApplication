<div *ngIf="detail">
  <div class="form-constructor-control">
    <div class="form-constructor-wrapper">
      <div class="field-list">
        <div class="tile-span">
          <ng-container *ngFor="let tileControl of tileOps.tileFormFields">
            <ng-container
              *ngTemplateOutlet="
                tileControlTpl;
                context: { tileControl: tileControl }
              "
            ></ng-container>
          </ng-container>
          <div class="button-group">
            <button
              mat-icon-button
              matTooltip="Create tile"
              matTooltipPosition="above"
              [disabled]="!enableFormConstructor"
              (click)="tileOps.createTile()"
            >
              <mat-icon class="success-color">add_circle_outline</mat-icon>
            </button>

            <button
              mat-icon-button
              color="warn"
              matTooltip="Clear all tiles"
              matTooltipPosition="above"
              (click)="tileOps.clearAllTiles()"
              [disabled]="!drawMatrix.tiles.size"
            >
              <mat-icon class="danger-color">delete_sweep</mat-icon>
            </button>
          </div>
        </div>
      </div>
      <div>
        <mat-slide-toggle
          matTooltip="Turn form constructor on/off"
          matTooltipPosition="above"
          [checked]="enableFormConstructor"
          (change)="toggleFormConstructor($event)"
        >
          {{ "Form Constructor " + (enableFormConstructor ? "ON" : "OFF") }}
        </mat-slide-toggle>
      </div>
    </div>

    <mat-divider></mat-divider>

    <div class="form-constructor-main">
      <div class="form-container" cdkDropListGroup>
        <ng-container
          *ngFor="let row of drawMatrix.drawMatrix; let rowIndex = index"
        >
          <ng-container *ngFor="let col of row; let colIndex = index">
            <ng-container
              *ngTemplateOutlet="
                tileTpl;
                context: {
                  rowIndex: rowIndex,
                  colIndex: colIndex,
                  tileId: getTileIdFromMatrix(rowIndex, colIndex)
                }
              "
            ></ng-container>
          </ng-container>
        </ng-container>
      </div>
    </div>
    <div *ngIf="!enableFormConstructor" class="form-control-elements">
      <button mat-fab extended (click)="formActions.saveAction()">
        <mat-icon>save_as</mat-icon>
        UPDATE FORM
      </button>
    </div>
  </div>
</div>

<mat-menu #menu>
  <ng-template matMenuContent let-element="element">
    <ng-container
      [ngTemplateOutlet]="actions"
      [ngTemplateOutletContext]="{
        element: element
      }"
    ></ng-container>
  </ng-template>
</mat-menu>

<ng-template #actions>
  @for (action of formContextMenuActions.allActions; track action; ) {
  <div style="padding-right: 20px; padding-left: 15px">
    <base-checkbox
      (click)="$event.stopPropagation()"
      *ngIf="action.appEntity?.mainControl?.type === CONTROL_TYPE.BOOLEAN"
      [alias]="action.appEntity?.alias || ''"
      [formGroup]="formContextMenuActions.formContextMenuFormGroup"
      [placeholder]="action.description"
      [action]="action.appEntity?.action"
    />
    <base-input
      (click)="$event.stopPropagation()"
      *ngIf="action.appEntity?.mainControl?.type === CONTROL_TYPE.INPUT"
      [alias]="action.appEntity?.alias || ''"
      [placeholder]="action.description"
      [formGroup]="formContextMenuActions.formContextMenuFormGroup"
      [action]="action.appEntity?.action"
    />
  </div>
  }
</ng-template>

<ng-template #tileControlTpl let-tileControl="tileControl">
  <base-select
    *ngIf="tileControl.mainControl?.type === CONTROL_TYPE.SELECT"
    [alias]="tileControl.alias"
    [placeholder]="tileControl.placeholder"
    [formGroup]="tileOps.tileFormGroup"
    [filterLocalSource]="tileControl.mainControl?.filterLocalSource"
    [action]="tileControl.action"
  />
  <base-input
    *ngIf="tileControl.mainControl?.type === CONTROL_TYPE.INPUT"
    [alias]="tileControl.alias"
    [formGroup]="tileOps.tileFormGroup"
    [placeholder]="tileControl.placeholder"
  />
</ng-template>

<ng-template
  #tileTpl
  let-rowIndex="rowIndex"
  let-colIndex="colIndex"
  let-tileId="tileId"
>
  @if (tileId) {
  <ng-container *ngIf="drawMatrix.tiles.get(tileId) as tile">
    <div
      [ngClass]="'tile ' + (enableFormConstructor && 'tile-visibility')"
      cdkDropListOrientation="horizontal"
      cdkDropList
      [cdkDropListData]="tile.cdkDropListData"
      (cdkDropListDropped)="tileOps.drop($event)"
    >
      <ng-container *ngFor="let f of tile.cdkDropListData">
        <div
          cdkDrag
          [cdkDragDisabled]="!enableFormConstructor"
          class="form-item"
          [contextMenuTriggerFor]="enableFormConstructor ? menu : null"
          (contextmenu)="setCurrentFormElementForContextMenu(f)"
        >
          <ng-container
            *ngTemplateOutlet="formFieldTpl; context: { f: f }"
          ></ng-container>
        </div>
      </ng-container>
    </div>
  </ng-container>
  } @else {
  <div
    class="anchor-point"
    [style.top]="rowIndex * rowHeight + 'px'"
    [style.left]="'calc(100%*' + colIndex + '/' + colQty + ')'"
    [style.width]="'calc(100%/' + colQty + ')'"
    [style.height]="rowHeight + 'px'"
  ></div>
  }
</ng-template>

<ng-template #formFieldTpl let-f="f">
  <base-input
    *ngIf="f.mainControl?.type === CONTROL_TYPE.INPUT"
    [alias]="f.alias"
    [placeholder]="f.placeholder"
    [formGroup]="formGroup"
    [formFieldColor]="f.color || ''"
  />
  <base-select
    *ngIf="f.mainControl?.type === CONTROL_TYPE.SELECT"
    [alias]="f.alias"
    [placeholder]="f.placeholder"
    [controllerPath]="controllerPath"
    [formGroup]="formGroup"
    [dependentAliases]="f.mainControl?.dependentAliases || []"
    [formFieldColor]="f.color || ''"
  />
  <base-checkbox
    *ngIf="f.mainControl?.type === CONTROL_TYPE.BOOLEAN"
    [alias]="f.alias"
    [formGroup]="formGroup"
    [placeholder]="f.placeholder"
    [outputStringValue]="f.cell && f.cell(detail)"
  />
  <base-date-picker
    *ngIf="f.mainControl?.type === CONTROL_TYPE.DATE_INPUT"
    [alias]="f.alias"
    [formGroup]="formGroup"
    [placeholder]="f.placeholder"
    [formFieldColor]="f.color || ''"
  />
  <base-text-field
    *ngIf="f.mainControl?.type === CONTROL_TYPE.TEXT"
    [alias]="f.alias"
    [placeholder]="f.placeholder"
    [formGroup]="formGroup"
    [formFieldColor]="f.color || ''"
  />
</ng-template>
